name: Release and sync branches on dated commit

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: release-and-sync-main
  cancel-in-progress: false

jobs:
  release-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Parse commit message for date
        id: parse
        shell: bash
        run: |
          msg='${{ github.event.head_commit.message }}'
          echo "Commit message: $msg"
          if [[ "$msg" =~ ([0-9]{2}\.[0-9]{2}\.[0-9]{4}) ]]; then
            date="${BASH_REMATCH[1]}"
            echo "Found date: $date"
            echo "date=$date" >> "$GITHUB_OUTPUT"
          else
            echo "No date pattern (dd.MM.yyyy) found in commit message. Skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop if no date present
        if: steps.parse.outputs.skip == 'true'
        run: echo "No dated commit. Job ends."

      - name: Create dated release (tag = date)
        if: steps.parse.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const date = `${{ steps.parse.outputs.date }}`;
            const sha = context.sha;
            core.info(`Preparing release for date: ${date} at sha ${sha}`);
            try {
              const existing = await github.rest.repos.getReleaseByTag({ owner, repo, tag: date });
              core.info(`Release already exists: ${existing.data.html_url}`);
            } catch (e) {
              core.info('Release not found, creating...');
              const created = await github.rest.repos.createRelease({
                owner,
                repo,
                tag_name: date,
                target_commitish: 'main',
                name: `Release ${date}`,
                body: `Automated release for ${date}.\nCommit: ${sha}`,
                draft: false,
                prerelease: false
              });
              core.info(`Release created: ${created.data.html_url}`);
            }

      - name: Open PRs to other branches
        if: steps.parse.outputs.skip != 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_PR != '' && secrets.PAT_PR || github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const date = `${{ steps.parse.outputs.date }}`;
            const sha = context.sha;

            const branchesResp = await github.rest.repos.listBranches({ owner, repo, per_page: 100 });
            const branches = branchesResp.data.map(b => b.name).filter(n => n !== 'main');
            core.info(`Target branches: ${branches.join(', ') || '(none)'}`);

            if (branches.length === 0) {
              core.info('No additional branches found. Nothing to sync.');
              return;
            }

            for (const baseBranch of branches) {
              try {
                const prs = await github.rest.pulls.list({ owner, repo, state: 'open', base: baseBranch, per_page: 100 });
                let existing = prs.data.find(pr => pr.head && pr.head.ref === 'main');
                if (!existing) {
                  core.info(`Creating PR from main to ${baseBranch} (no auto-merge)...`);
                  const pr = await github.rest.pulls.create({
                    owner,
                    repo,
                    title: `Sync main -> ${baseBranch} (${date})`,
                    head: 'main',
                    base: baseBranch,
                    body: `Automated sync from main on ${date}.\nCommit: ${sha}`
                  });
                  existing = pr.data;
                  core.info(`PR #${existing.number} created for ${baseBranch}`);
                } else {
                  core.info(`Existing PR #${existing.number} already open for ${baseBranch}`);
                }
              } catch (err) {
                if (err.status === 403) {
                  core.warning('403: Actions token cannot create PRs. Provide PAT_PR secret or enable repo settings (read & write + allow Actions to create/approve PRs).');
                } else {
                  core.warning(`Failed PR operation for ${baseBranch}: ${err.message}`);
                }
              }
            }
